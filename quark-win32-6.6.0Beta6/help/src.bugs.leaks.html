<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <title>Leakhunt</title>
  <meta name="Description" content="QuArK Information Database - Page: 4.7.2.&nbsp;Leakhunt">
  <meta name="Keywords" content="QuArK InfoBase Quake Army Knife QRK QKM Python PY Map Editor Hexen Heretic Half-Life Sin Kingpin Soldier-of-Fortune Star-Trek-Voyager Elite-Force">
  <link rel=stylesheet href="standard.css" type="text/css">
</head>

<body>
<a name="__top__"></a>
<table width="100%" border=0 cellspacing=0>
  <tr>
    <td width=213>
      <a target="_blank" href="http://quark.sourceforge.net/"><img src="quarkicon.png" width=213 height=90 border=0 alt="Go to QuArK Web Site"></a>
    </td>
    <td width="70%" align=center>
      <div class="topheadline">Leakhunt</div>
      <div class="sm">Updated&nbsp;09 Jul 2012</div>
    </td>
    <td width="30%" valign=bottom nowrap>
      Upper&nbsp;levels:<br>-&nbsp;<a href="index.html">QuArK&nbsp;Information&nbsp;Base</a><br>-&nbsp;<a href="src.html">4.&nbsp;The&nbsp;Source&nbsp;Code</a><br>-&nbsp;<a href="src.bugs.html">4.7.&nbsp;Known&nbsp;bugs&nbsp;in&nbsp;the&nbsp;Source&nbsp;...</a><br>
    </td>
  </tr>
</table>
<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="99%">
      <p class="headline">&nbsp;4.7.2.&nbsp;Leakhunt</p>
    </td>
    <td width="1%" align=right nowrap>
      &nbsp;[&nbsp;<span class="navenable"><a href="src.bugs.range.html">Prev</a></span>&nbsp;-&nbsp;<span class="navenable"><a href="src.bugs.html">Up</a></span>&nbsp;-&nbsp;<span class="navenable"><a href="src.bugs.destroy.html">Next</a></span>&nbsp;]&nbsp;
    </td>
  </tr>
</table>
<table border=0 width="100%" cellspacing=10><tr><td><p>User reports and the use of Atanas Stoyanov's <a target="_blank" href="http://www.automatedqa.com">
Memproof<a> reveals a substantial assortment of resource and memory
leaks.  Unfortunately it's not entirely clear which ones are genuine
and which ones are Memproof misreports or Delphi bugs, but it is possible
that most of the really important ones have been dealt with.
</p><p>So here are listed various things that still appear, organized by
when they show up, followed by some other items.
These leaks only include those reported when the
`specifics sharing' scheme is disabled, by compiling with the flag
`Noshare'.  Sorting the apparent specifics-sharing scheme leaks out
is a challenge we have not yet risen to (since specifics sharing is
arcane, involves assembler code, etc., the reports may well be spurious).
As of 6.5.0 Beta 2, a lot of these problems have been fixed, however
some might remain.
</p><p>Developer Mode in QuArK also enables a command to track memory usage,
and compare current used message to that from the last call to it.
This can be used to tell if inordinate amounts of memory are being
consumed by map editing operations (of course the undo stack will get
bigger as editing procedes, etc.).
</p>
</td></tr></table>
<br>

<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="100%">
      <p class="subheadline">&nbsp;Index</p>
    </td>
  </tr>
</table>
<ul class="index">
  <li>- <a href="#tools">Hunting tools</a>&nbsp;<span class="added">(09 Jul 2012)</span>
  <li>- <a href="#open">Opening and Closing QuArK</a>&nbsp;<span class="added">(10 May 2007)</span>
  <li>- <a href="#map">Open/Close Map Editor</a>&nbsp;<span class="added">(10 May 2007)</span>
  <li>- <a href="#dicts">Using dicts</a>&nbsp;<span class="added">(12 Sep 2008)</span>
  <li>- <a href="#event">Unfreed Event (don't mess with)</a>&nbsp;<span class="added">(10 May 2007)</span>
  <li>- <a href="#popup">Popup Menus (resolved)</a>&nbsp;<span class="added">(10 May 2007)</span>
</ul>
<br>


<a name="tools"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Hunting tools</p>
      </td>
      <td align=right>
        <font size=-2>DanielPharos&nbsp;-&nbsp;09 Jul 2012</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>There are many tools out there that can be used to locate and
eliminate memory leaks.  Here's a small list of some of them,
and where to find them:
</p><p><strong>WinDBG (Debugging Tools for Windows)</strong><br>
Microsofts official debugging tools.  Might come in handy, but
it can only be used on the actual executable, and thus can
only be applied when searching for leaks the hard way, or for
locating crashes.
</p><p>Website:
<a target="_blank" href="http://www.microsoft.com/whdc/devtools/debugging/default.mspx">http://www.microsoft.com/whdc/devtools/debugging/default.mspx</a>
</p><p><strong>VMMap</strong><br>
Another useful tool is VMMap.  This tool displays all memory
allocations from a process, so memory leaks should be easy
to spot.  It even can search from strings in specific memory
block, so it's possible to identify what exactly is leaking.
</p><p>Website:
<a target="_blank" href="http://technet.microsoft.com/en-us/sysinternals/dd535533.aspx">http://technet.microsoft.com/en-us/sysinternals/dd535533.aspx</a>
</p><p><strong>MemProof</strong><br>
A program that monitors the executable realtime, and lists
memory usage.  When the program finishes, all the memory still
being used has obviously leaked.
</p><p>Website:
<a target="_blank" href="http://www.automatedqa.com/products/memproof/">http://www.automatedqa.com/products/memproof/</a>
</p><p><strong>MemCheck</strong><br>
Being an alternative memory manager, this replaces the old
MemTester.pas that QuArK uses at the moment.  This has already
been done: all you need to do is to open the .dpr file in the
source directory, comment out MemTester, comment in MemCheck
AND the MemChk below at the end of the file, and you're done.
</p><p>Website:
<a target="_blank" href="http://v.mahon.free.fr/pro/freeware/memcheck/">http://v.mahon.free.fr/pro/freeware/memcheck/</a>
</p><p><strong>FastMM</strong><br>
Another alternative memory manager.  This one is actually so
good, that even Borland (developers of Delphi) started using
this in Delphi 2006!  It has a settings file,
source/prog/FastMM4Options.inc. To enable the Full Debug Mode,
you will need to place a DLL file into your runtime directory.
See the FastMM readme file for more information.
</p><p>Website:
<a target="_blank" href="http://sourceforge.net/projects/fastmm/">http://sourceforge.net/projects/fastmm/</a>
</p>
<p>The alternative memory managers have already been installed into QuArK. You can enable them by editing the MemManager.inc file and switching the comment-tags. Note: Only one can be enabled at a time!
</p><p>Also, don't forget:<br>
There are a lot of debugging options already present in
Delphi (at least in 6 and higher).  Don't forget to check
the Project &gt; Options &gt; Compiler/Compiler Messages/Linker
settings in Delphi.  Also, some of these options have to
be enabled in order to use the full power of the tools
listed above.  Read the respective readme file that comes
with the tool for more information.
</p><p><hr>
</p><p>Another tool to hunt for problems (especially Python reference
counter bugs) is the plugin called 'devpyobjects.py', which
can output a file containing a list of all the active Python
objects currently in memory. See the file (located in the
'plugins' directory) for more info.
</p>
  </td></tr></table>
  <br>

<a name="open"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Opening and Closing QuArK</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;10 May 2007</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p><UL>
<LI>Windows errors
<UL>
<LI> 1 unfreed cursor handle (all the lines reported from Delphi units)
<LI> 3 unclosed registry keys from SystemDetails.pas (Some fixed as of 6.5.0 Beta 2)
<LI> 1 attempt to free an unexisting resource, triggered from QkForm.pas:422(QkForm.Destroy)
</UL>
<LI> 1 unclosed event handle, which shouldn't be dealt with.  Some
discussion of it by Decker appears in <a href="src.bugs.leaks.html#event">'Unfreed Event (don't mess with)'</a>.
</p><p><LI>Live Pointers (memory leaks)
<UL>
<LI> 1 from Maperror.pas:39 (initialization) (Fixed as of 6.5.0 Beta 2)
<LI> 2 from PngImage.pas, probably not much we can do about them. (Fixed as of 6.5.0 Beta 2)
<LI> 1 from SystemDetails.pas:1090 (GetMachine) (Fixed as of 6.5.0 Beta 2)
<LI> 1 from SystemDetails.pas:1105 (GetUser) (Fixed as of 6.5.0 Beta 2)
</UL>
</UL>
</p><p>There are more in the code. As of 6.5.0 Beta, lots have been fixed, but many probably still
remain.
</p>
  </td></tr></table>
  <br>

<a name="map"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Open/Close Map Editor</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;10 May 2007</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p><UL>
<LI>Windows Errors
<UL>
<LI>Three attempts to free unexisting resources from PyMapView.pas:2358 (mdrawmap)
<LI>Another attempt to free an unexisting resource from QkForm.pas:422(QkForm.Destroy),
with a different call stack from the one from opening and closing QuArK.
</UL>
</p>
  </td></tr></table>
  <br>

<a name="dicts"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Using dicts</p>
      </td>
      <td align=right>
        <font size=-2>DanielPharos&nbsp;-&nbsp;12 Sep 2008</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>Another one, found out the hard way: the function 'dictspec'
(and probably 'dictitems' also) is leaking memory. This becomes
painfully obvious when called a LOT of times. The items inside
the dictionary might not have the correct reference counter set?
</p><p>Example:
plugins/mdltools.py: (found in version 1.13, changed in version
1.14)<br>
Just change
</p><p><div class="doccode"><pre>rulerlist[facenbr]['v']</pre></div>
</p><p>into:
</p><p><div class="doccode"><pre>rulerlist[facenbr].dictspec['v']</pre></div>
</p><p>and see the memory slowly build up whenever you zoom or pan.
(Or just redraw!)
</p><p>Update:
Should be fixed as of QuArK 6.6.0 Beta 1/2!
</p>
  </td></tr></table>
  <br>

<a name="event"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Unfreed Event (don't mess with)</p>
      </td>
      <td align=right>
        <font size=-2>Decker (mostly) & tiglari&nbsp;-&nbsp;10 May 2007</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>The kernel error CreatEvent generated at QkFileObjects.pas:RestoreAutoSaved
line 2061 should not be fixed by deleting the event; here's what Decker had
to say about my attempt to do that:
</p><p>Oops I believe you just introduced &quot;an unintended bug&quot;.
</p><p>I've looked at that particular piece of code before (less than a month
ago I think), and made up my mind of what it does. Unfortunatly I never
got around to document it. Armin should have done that, when he coded
it. It has something to do, when running two or more instances of QuArK
on the same machine at the same time, and the crashes of QuArK.
</p><p>Here's my thoughts of it:
</p><p>- The procedure is called &quot;RestoreAutoSaved&quot;, so it might have something
to do with when QuArK crashes and is started again.<br>
- There is a call to &quot;GetCurrentProcessId&quot; at the bottom of the
procedure. So some kind of 'uniqueness' is apparently needed.<br>
- The call to &quot;WaitForSingleObject&quot; has a timeout-value of 0, e.g. don't
wait (quite strange!?).<br>
- The file named &quot;auto-save-<something>&quot;, is also referenced in the
procedure &quot;QFileObject.PyGetAttr&quot;, where it too use
&quot;GetCurrentProcessId&quot;.<br>
- &quot;OldId&quot; gets assigned the value from the file named
&quot;auto-save-<something>&quot;.<br>
- So &quot;OldId&quot; may actually be the ProcessId of the QuArK-instance which
created the auto-save file.<br>
- Note that the const &quot;TagAtom&quot; with value &quot;~QuArK-tag-auto-save-%x&quot;,
gets its &quot;%x&quot; replaced by &quot;OldId&quot;.<br>
- The Delphi documentation for &quot;CreateEvent()&quot; does not directly states
what will be returned, if the name-of-the-event-semaphore already exists
(e.g. another instance of QuArK is already running.) I believe that we
get an invalid handle back in that case.<br>
- The &quot;WaitForSingleObject()&quot; call, destroys &quot;OldId&quot; and assigns it a
completly different purpose; it now contains the return value of the
call. (Bad code style! Better use a variable clearly defined for the
purpose, instead of reusing variables).<br>
- &quot;OldId&quot;, which is now the return-value from &quot;WaitForSingleObject()&quot;,
gets compared against zero. So can &quot;WaitForSingleObject()&quot; return zero,
and what does zero mean in that case? The Delphi documentation does not
say, so a dig into WINDOWS.PAS searching for the documented return
symbols may tell us what zero means.<br>
- I find that the symbol &quot;WAIT_OBJECT_0&quot; has the constant value of zero,
so statement in &quot;RestoreAutoSaved&quot; would be better written as:<br>
        if (OldId = WAIT_OBJECT_0) then<br>
- Putting some of the stuff together:<br>
  CreateEvent(nil, false, TRUE, <a replaced TagAtom string>);<br>
Note the TRUE, according to the Delphi documentation, this sets the
event-semaphore into a Signaled-State. I then believe, that if
CreateEvent() did not succeed in creating the event-semaphore, the event
is Not Signaled, and therefore WaitForSingleObject() will not return
WAIT_OBJECT_0.<br>
- This could mean that there is another QuArK instance running at the
same time, and therefore the auto-save file is not due to a crashed
QuArK, as it is still running.<br>
</p><p>- Note also, that any events owned by a process, the one who called
CreateEvent(), gets automatically released/closed by the
operation-system when that process stops/crashes. Thats why Armin never
did nor should do a CloseHandle() on the last CreateEvent(), as it will
destroy the purpose of the WaitForSingleObject() check.
</p><p>Phew... that was a bit much, for such a little thing ;-)
</p><p>I know a bit about event/mutex-semaphores, as I use them at work these
days, porting an OS/2-application to Windows 2000 Advanced Server.
</p>
  </td></tr></table>
  <br>

<a name="popup"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;Popup Menus (resolved)</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;10 May 2007</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>Well this one seems to be cleared by destroying the menubarhandle in
the TPyForm.FormDestroy method in PyForms.pas ...
</p><p>Easy money!
</p><p>*******
</p><p>The User|Menu|CreatePopup Menu error appears to be noncrititical.  11 popup
menus are created when the map editor is started, and not properly deleted
on closure but operation of the map editor does not seem to create more of
these errors.  The menu creation code is run when the buttons in the button
panel are pressed, but the resulting menus are propely deleted.
</p><p>However, it would probably be good to attend to this someday, since these
popups, and one ordinary menu, are created and not deleted every time the
map editor is started, so if it's started once in a session you get 12
menu errors; twice, 24.
</p>
  </td></tr></table>
  <br>

<br>

<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="99%" align=center>
      <p class="sm">
        Copyright (c) 2009, GNU General Public License by The QuArK (Quake Army Knife) Community - <a target="_blank" href="http://quark.sourceforge.net/">http://quark.sourceforge.net/</a><br>
      </p>
    </td>
    <td width="1%" align=right nowrap>
      &nbsp;[&nbsp;<span class="navenable"><a href="src.bugs.range.html">Prev</a></span>&nbsp;-&nbsp;<a href="#__top__">Top</a>&nbsp;-&nbsp;<span class="navenable"><a href="src.bugs.destroy.html">Next</a></span>&nbsp;]&nbsp;
    </td>
  </tr>
</table>
</body>
</html>